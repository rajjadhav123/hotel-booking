<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ hotel.name }} - Details</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- FullCalendar CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
  <style>
    .room-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .room-item.booked {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .room-item.available {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    .calendar-container {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .fc-event {
      cursor: pointer;
      padding: 2px 5px;
    }
    .room-status-indicator {
      display: inline-block;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .available-indicator {
      background-color: #28a745;
    }
    .booked-indicator {
      background-color: #dc3545;
    }
    .view-toggle {
      margin-bottom: 15px;
    }
    
    /* Additional calendar styles from template */
    .calendar-legend {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .room {
      padding: 3px;
      font-size: 12px;
      border-radius: 3px;
      width: 15px;
      height: 15px;
    }
    
    .room.available {
      background-color: #28a745;
    }
    
    .room.booked {
      background-color: #dc3545;
    }
    
    /* Custom calendar styles */
    .custom-calendar {
      margin-top: 20px;
    }
    
    .month-navigation {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .month-navigation button {
      background: #f0f0f0;
      border: 1px solid #ddd;
      padding: 5px 15px;
      margin: 0 10px;
      cursor: pointer;
      border-radius: 3px;
    }
    
    .month-navigation h3 {
      margin: 0;
      min-width: 200px;
      text-align: center;
    }
    
    .calendar-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .calendar-table th, .calendar-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }
    
    .calendar-table th {
      background-color: #f5f5f5;
    }
    
    .day-number {
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .room-status {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-3">← Back to Hotels</a>
    
    <div class="row">
      <div class="col-md-8">
        <h2>{{ hotel.name }}</h2>
        <p class="lead">Location: {{ hotel.location }}</p>
        <div id="hotel-data" data-hotel-id="{{ hotel.id }}"></div>
      </div>
    </div>

    <div class="view-toggle">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary active" id="list-view-btn">List View</button>
        <button type="button" class="btn btn-outline-primary" id="calendar-view-btn">Calendar View</button>
      </div>
    </div>

    <!-- List View -->
    <div id="list-container">
      <h4>Available Rooms</h4>
      {% for room in rooms %}
      <div class="room-item {% if room.is_booked %}booked{% else %}available{% endif %}">
        <div class="row">
          <div class="col-md-8">
            <h5>{{ room.room_type }}</h5>
            <p class="mb-1">
              Status: 
              {% if room.is_booked %}
              <span class="badge bg-danger">Booked</span>
              {% else %}
              <span class="badge bg-success">Available</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-4 text-end">
            {% if not room.is_booked %}
            <button type="button" class="btn btn-primary book-room-btn" data-room-id="{{ room.id }}" data-room-type="{{ room.room_type }}" data-bs-toggle="modal" data-bs-target="#bookingModal">
              Book Now
            </button>
            {% else %}
            <button class="btn btn-secondary" disabled>Not Available</button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Calendar View -->
    <div id="calendar-container" class="calendar-container" style="display: none;">
      <div class="btn-group mb-3" role="group">
        <button type="button" class="btn btn-outline-primary active" id="fullcalendar-btn">Interactive Calendar</button>
        <button type="button" class="btn btn-outline-primary" id="simple-calendar-btn">Simple Calendar</button>
      </div>
      
      <!-- FullCalendar View -->
      <div id="fullcalendar-view">
        <div class="legend mb-3">
          <span><span class="room-status-indicator available-indicator"></span> Available</span>
          <span class="ms-3"><span class="room-status-indicator booked-indicator"></span> Booked</span>
        </div>
        <div id="room-calendar"></div>
      </div>
      
      <!-- Simple Calendar View -->
      <div id="simple-calendar-view" class="custom-calendar" style="display: none;">
        <div class="calendar-legend">
          <div class="legend-item"><span class="room available"></span> Available</div>
          <div class="legend-item"><span class="room booked"></span> Booked</div>
        </div>
        <div id="simple-calendar-container"></div>
      </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bookingModalLabel">Book Room</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="booking-form" action="" method="post">
              <input type="hidden" id="room_id" name="room_id">
              
              <div class="mb-3">
                <label for="checkin_date" class="form-label">Check-in Date</label>
                <input type="date" class="form-control" id="checkin_date" name="checkin_date" min="{{ current_date }}" required>
              </div>
              
              <div class="mb-3">
                <label for="checkout_date" class="form-label">Check-out Date</label>
                <input type="date" class="form-control" id="checkout_date" name="checkout_date" min="{{ current_date }}" required>
              </div>
              
              <div class="mb-3">
                <h5>Payment Details</h5>
                <div class="card p-3">
                  <p class="mb-1">Room: <span id="selected-room-type"></span></p>
                  <p class="mb-1">Price: ₹1500 per night</p>
                  <p class="mb-1">Total: ₹<span id="total-price">0</span></p>
                </div>
              </div>
              
              <button type="button" class="btn btn-primary w-100" id="payment-button">Proceed to Payment</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Required JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <script>
    // Room data from Flask
    const rooms = [
      {% for room in rooms %}
      {
        id: {{ room.id }},
        roomType: "{{ room.room_type }}",
        isBooked: {{ room.is_booked|lower }},
        // Random booking data for demo purposes - in real app, fetch this from database
        bookings: [
          {% if room.is_booked %}
          {
            start: moment().subtract(Math.floor(Math.random() * 5), 'days').format('YYYY-MM-DD'),
            end: moment().add(Math.floor(Math.random() * 10) + 1, 'days').format('YYYY-MM-DD')
          }
          {% endif %}
        ]
      },
      {% endfor %}
    ];

    // Hotel id for API calls
    const hotelId = {{ hotel.id }};
    
    // Price per night - in real app, this would come from the database
    const pricePerNight = 1500;
    
    // Initialize the calendars
    let fullCalendarInstance;
    
    // Handle view toggling
    document.getElementById('calendar-view-btn').addEventListener('click', function() {
      // Switch active button 
      document.getElementById('list-view-btn').classList.remove('active');
      this.classList.add('active');
      
      // Show calendar, hide list
      document.getElementById('calendar-container').style.display = 'block';
      document.getElementById('list-container').style.display = 'none';
      
      // Initialize full calendar if not already done
      if (!fullCalendarInstance) {
        fullCalendarInstance = $('#room-calendar').fullCalendar({
          header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek'
          },
          defaultView: 'month',
          editable: false,
          events: generateCalendarEvents(),
          eventClick: function(calEvent) {
            if (!calEvent.isBooked) {
              // If room is available on this date, open booking modal
              $('#room_id').val(calEvent.roomId);
              $('#selected-room-type').text(calEvent.title);
              $('#checkin_date').val(calEvent.start.format('YYYY-MM-DD'));
              $('#checkout_date').val(moment(calEvent.start).add(1, 'days').format('YYYY-MM-DD'));
              updateTotalPrice();
              $('#bookingModal').modal('show');
            }
          }
        });
      }
      
      // Show appropriate calendar view
      const isSimpleCalendarVisible = document.getElementById('simple-calendar-btn').classList.contains('active');
      document.getElementById('fullcalendar-view').style.display = isSimpleCalendarVisible ? 'none' : 'block';
      document.getElementById('simple-calendar-view').style.display = isSimpleCalendarVisible ? 'block' : 'none';
      
      // Initialize simple calendar if selected
      if (isSimpleCalendarVisible && !document.getElementById('simple-calendar-container').innerHTML) {
        fetchRoomAvailabilityData();
      }
    });
    
    document.getElementById('list-view-btn').addEventListener('click', function() {
      // Switch active button
      document.getElementById('calendar-view-btn').classList.remove('active');
      this.classList.add('active');
      
      // Show list, hide calendar
      document.getElementById('list-container').style.display = 'block';
      document.getElementById('calendar-container').style.display = 'none';
    });
    
    // Toggle between calendar types
    document.getElementById('fullcalendar-btn').addEventListener('click', function() {
      document.getElementById('simple-calendar-btn').classList.remove('active');
      this.classList.add('active');
      document.getElementById('fullcalendar-view').style.display = 'block';
      document.getElementById('simple-calendar-view').style.display = 'none';
    });
    
    document.getElementById('simple-calendar-btn').addEventListener('click', function() {
      document.getElementById('fullcalendar-btn').classList.remove('active');
      this.classList.add('active');
      document.getElementById('fullcalendar-view').style.display = 'none';
      document.getElementById('simple-calendar-view').style.display = 'block';
      
      // Initialize simple calendar if not already done
      if (!document.getElementById('simple-calendar-container').innerHTML) {
        fetchRoomAvailabilityData();
      }
    });
    
    // Generate calendar events from room data
    function generateCalendarEvents() {
      const events = [];
      
      // Generate events for the next 60 days
      const startDate = moment();
      const endDate = moment().add(60, 'days');
      
      rooms.forEach(room => {
        // For each day in the range
        let currentDate = startDate.clone();
        while (currentDate.isSameOrBefore(endDate)) {
          const dateStr = currentDate.format('YYYY-MM-DD');
          
          // Check if room is booked on this date
          const isBooked = room.bookings.some(booking => {
            return currentDate.isBetween(booking.start, booking.end, null, '[]');
          });
          
          // Add an event for this room on this day
          events.push({
            title: room.roomType,
            start: dateStr,
            end: dateStr,
            roomId: room.id,
            isBooked: isBooked || room.isBooked,
            color: isBooked || room.isBooked ? '#dc3545' : '#28a745',
            textColor: '#fff'
          });
          
          currentDate.add(1, 'days');
        }
      });
      
      return events;
    }
    
    // Setup booking process
    document.querySelectorAll('.book-room-btn').forEach(button => {
      button.addEventListener('click', function() {
        const roomId = this.getAttribute('data-room-id');
        const roomType = this.getAttribute('data-room-type');
        
        // Set form values
        document.getElementById('room_id').value = roomId;
        document.getElementById('selected-room-type').textContent = roomType;
      });
    });
    
    // Update total price when dates change
    document.getElementById('checkin_date').addEventListener('change', updateTotalPrice);
    document.getElementById('checkout_date').addEventListener('change', updateTotalPrice);
    
    function updateTotalPrice() {
      const checkinDate = document.getElementById('checkin_date').value;
      const checkoutDate = document.getElementById('checkout_date').value;
      
      if (checkinDate && checkoutDate) {
        const start = moment(checkinDate);
        const end = moment(checkoutDate);
        const nights = end.diff(start, 'days');
        
        if (nights > 0) {
          const totalPrice = nights * pricePerNight;
          document.getElementById('total-price').textContent = totalPrice;
          return totalPrice;
        }
      }
      
      document.getElementById('total-price').textContent = '0';
      return 0;
    }
    
    // Handle payment button click
    document.getElementById('payment-button').addEventListener('click', function() {
      const roomId = document.getElementById('room_id').value;
      const checkinDate = document.getElementById('checkin_date').value;
      const checkoutDate = document.getElementById('checkout_date').value;
      const totalPrice = updateTotalPrice();
      
      if (!roomId || !checkinDate || !checkoutDate || totalPrice <= 0) {
        alert('Please select valid dates');
        return;
      }
      
      // Create Razorpay order
      fetch('/create-order', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: totalPrice
        })
      })
      .then(response => response.json())
      .then(order => {
        if (order.error) {
          alert('Error: ' + order.error);
          return;
        }
        
        // Initialize Razorpay
        const options = {
          key: '{{ razorpay_key_id }}',
          amount: order.amount,
          currency: order.currency,
          name: '{{ hotel.name }}',
          description: 'Room Booking',
          order_id: order.id,
          handler: function(response) {
            // On successful payment, confirm the booking
            fetch('/confirm-booking', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                room_id: roomId,
                checkin_date: checkinDate,
                checkout_date: checkoutDate,
                payment_id: response.razorpay_payment_id
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.error) {
                alert('Error: ' + data.error);
              } else {
                // Redirect to success page
                window.location.href = "/my-bookings";
              }
            });
          },
          prefill: {
            name: '{{ session.username }}',
          },
          theme: {
            color: '#3399cc'
          }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Payment initialization failed');
      });
    });
    
    // Functions for simple calendar view
    function fetchRoomAvailabilityData() {
      // In a real application, fetch this from the server
      // For now, we'll use the same data as FullCalendar
      buildSimpleCalendar(rooms);
    }
    
    function buildSimpleCalendar(roomsData) {
      const calendarContainer = document.getElementById('simple-calendar-container');
      if (!calendarContainer) return;
      
      // Get current date and create date range for calendar (current month)
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Create first day of month and last day of month
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      
      // Create month header
      const monthNames = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"];
      
      const calendarHeader = document.createElement('div');
      calendarHeader.className = 'month-navigation';
      calendarHeader.innerHTML = `
          <button id="prev-month-btn" class="btn btn-sm btn-outline-secondary">&lt;</button>
          <h3>${monthNames[currentMonth]} ${currentYear}</h3>
          <button id="next-month-btn" class="btn btn-sm btn-outline-secondary">&gt;</button>
      `;
      calendarContainer.appendChild(calendarHeader);
      
      // Create calendar table
      const calendarTable = document.createElement('table');
      calendarTable.className = 'calendar-table table table-bordered';
      
      // Add day headers
      const dayHeaders = document.createElement('tr');
      const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      
      daysOfWeek.forEach(day => {
          const th = document.createElement('th');
          th.textContent = day;
          dayHeaders.appendChild(th);
      });
      
      calendarTable.appendChild(dayHeaders);
      
      // Calculate days in month and create calendar grid
      const daysInMonth = lastDay.getDate();
      const firstDayOfWeek = firstDay.getDay(); // 0 for Sunday, 1 for Monday, etc.
      
      let dateCounter = 1;
      let calendarRows = [];
      
      // Create rows for the calendar
      for (let i = 0; i < 6; i++) { // Max 6 weeks in a month
          if (dateCounter > daysInMonth) break;
          
          const weekRow = document.createElement('tr');
          
          for (let j = 0; j < 7; j++) { // 7 days in a week
              const dayCell = document.createElement('td');
              
              if ((i === 0 && j < firstDayOfWeek) || dateCounter > daysInMonth) {
                  // Empty cell before first day or after last day
                  dayCell.innerHTML = '&nbsp;';
              } else {
                  // Valid day in month
                  const currentDate = new Date(currentYear, currentMonth, dateCounter);
                  const dateStr = formatDate(currentDate);
                  
                  dayCell.dataset.date = dateStr;
                  dayCell.innerHTML = `
                      <div class="day-number">${dateCounter}</div>
                      <div class="room-status" id="room-status-${dateStr}"></div>
                  `;
                  
                  dateCounter++;
              }
              
              weekRow.appendChild(dayCell);
          }
          
          calendarTable.appendChild(weekRow);
          calendarRows.push(weekRow);
      }
      
      calendarContainer.appendChild(calendarTable);
      
      // Fill room availability status
      populateRoomAvailability(roomsData, currentYear, currentMonth);
      
      // Add event listeners for month navigation
      document.getElementById('prev-month-btn').addEventListener('click', () => {
          calendarContainer.innerHTML = '';
          navigateMonth(-1);
      });
      
      document.getElementById('next-month-btn').addEventListener('click', () => {
          calendarContainer.innerHTML = '';
          navigateMonth(1);
      });
    }

    function navigateMonth(change) {
      // Get current date from URL or use today
      let currentDate = new Date();
      
      // Change month
      currentDate.setMonth(currentDate.getMonth() + change);
      
      // Rebuild calendar with new month
      buildSimpleCalendar(rooms);
    }

    function populateRoomAvailability(roomsData, year, month) {
      // Loop through each day of the month
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
          const currentDate = new Date(year, month, day);
          const dateStr = formatDate(currentDate);
          const roomStatusEl = document.getElementById(`room-status-${dateStr}`);
          
          if (!roomStatusEl) continue;
          
          // Check availability for each room on this date
          roomsData.forEach(room => {
              const isBooked = isRoomBooked(room, currentDate);
              const roomSpan = document.createElement('div');
              roomSpan.className = isBooked ? 'room booked' : 'room available';
              roomSpan.textContent = room.roomType.substring(0, 1); // Just the first letter to save space
              roomSpan.title = room.roomType;
              roomSpan.dataset.roomId = room.id;
              
              // Add click event for booking if available
              if (!isBooked) {
                roomSpan.style.cursor = 'pointer';
                roomSpan.addEventListener('click', function() {
                  $('#room_id').val(room.id);
                  $('#selected-room-type').text(room.roomType);
                  $('#checkin_date').val(dateStr);
                  $('#checkout_date').val(moment(dateStr).add(1, 'days').format('YYYY-MM-DD'));
                  updateTotalPrice();
                  $('#bookingModal').modal('show');
                });
              }
              
              roomStatusEl.appendChild(roomSpan);
          });
      }
    }

    function isRoomBooked(room, date) {
      // Check if room is booked for the given date
      if (room.isBooked) return true;
      
      const momentDate = moment(date);
      
      for (const booking of room.bookings) {
          const checkin = moment(booking.start);
          const checkout = moment(booking.end);
          
          // If date is between checkin and checkout (inclusive for checkin, exclusive for checkout)
          if (momentDate.isBetween(checkin, checkout, null, '[]')) {
              return true;
          }
      }
      
      return false;
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  </script>
</body>
</html>